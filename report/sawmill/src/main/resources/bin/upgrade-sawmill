#!/bin/bash

# This is a utility script for updating an old LogAnalysisInfo from a new one
# (during an update).  Run this script, and provide the pathnames of the old
# and new LogAnalysisInfo directories, and it will copy everything over.
# It will not modify the old LogAnalysisInfo directory.

usage () {
    echo "\nUsage: upgrade-sawmill <new-LogAnalysisInfo>"
    echo "\n  <new-LogAnalysisInfo>: the pathname of the new LogAnalysisInfo directory\n\n"
    exit
}

if [ $# -ne 1 ] || [[ "$1" != *LogAnalysisInfo ]]; then
    usage
fi

newlai=${1}
oldlai=/report_service/LogAnalysisInfo
oldconfig=/usr/local/report/old_config

today=`date +"%Y%m%d"`

if [ ! -d $oldlai ] || [ ! -d $newlai ] ; then
    echo
    echo "Directory does not exist."
    usage
fi

echo "Updating $newlai from the contents of ${oldlai} \n"

echo "cp ${oldlai}/users.cfg ${newlai}/users.cfg"
cp ${oldlai}/users.cfg ${newlai}/users.cfg

echo "cp ${oldlai}/licenses.cfg ${newlai}/licenses.cfg"
cp ${oldlai}/licenses.cfg ${newlai}/licenses.cfg

echo "cp ${oldlai}/schedule.cfg ${newlai}/schedule.cfg"
cp ${oldlai}/schedule.cfg ${newlai}/schedule.cfg

echo "cp ${oldlai}/system.cfg ${newlai}/system.cfg"
cp ${oldlai}/system.cfg ${newlai}/system.cfg

echo "cp ${oldlai}/preferences.cfg ${newlai}/preferences.cfg"
cp ${oldlai}/preferences.cfg ${newlai}/preferences.cfg

echo "cp ${oldlai}/roles_enterprise.cfg ${newlai}/roles_enterprise.cfg"
cp ${oldlai}/roles_enterprise.cfg ${newlai}/roles_enterprise.cfg

echo "cp ${oldlai}/roles_standard.cfg ${newlai}/roles_standard.cfg"
cp ${oldlai}/roles_standard.cfg ${newlai}/roles_standard.cfg

echo "cp -r ${oldlai}/profiles/* ${newlai}/profiles"
cp ${oldlai}/profiles/* ${newlai}/profiles

echo "cp ${oldlai}/rewrite_rules/* ${newlai}/rewrite_rules"
cp ${oldlai}/rewrite_rules/* ${newlai}/rewrite_rules

echo "cp -r ${oldlai}/users_cache ${newlai}/users_cache"
cp -r ${oldlai}/users_cache ${newlai}/users_cache

echo "cp -r ${oldlai}/Databases ${newlai}/Databases"
cp -r ${oldlai}/Databases ${newlai}/Databases

echo "\n\nCopying PDS Engineering-specific configurations."
echo "cp -r ${oldlai}/.svn ${newlai}"
cp -r ${oldlai}/.svn ${newlai}

echo "cp -r ${oldlai}/login_plugins ${newlai}"
cp -r ${oldlai}/login_plugins ${newlai}

echo "\n\nBackup old LogAnalysisInfo"
echo "mv ${oldlai} ${oldconfig}/LogAnalysisInfo_pre${today}"
mv ${oldlai} ${oldconfig}/LogAnalysisInfo_pre${today}

echo "\n\nMove new LogAnalysisInfo to mounted drive to support load balancing."
echo "mv ${newlai} ${oldlai}"
mv ${newlai} ${oldlai}

echo "\n\nLink to LogAnalyisInfo on mounted drive."
echo "ln -s ${oldlai} ${newlai}"
ln -s ${oldlai} ${newlai}

exit 0