#!/bin/bash

# This is a utility script for updating an old LogAnalysisInfo from a new one
# (during an update).  Run this script, and provide the pathnames of the old
# and new LogAnalysisInfo directories, and it will copy everything over.
# It will not modify the old LogAnalysisInfo directory.

usage () {
    echo "\nUsage: upgrade-sawmill <new-LogAnalysisInfo>"
    echo "\n  <new-LogAnalysisInfo>: the pathname of the new LogAnalysisInfo directory\n\n"
    exit
}

if [ $# -ne 1 ] || [[ "$1" != *LogAnalysisInfo ]]; then
    usage
fi

newlai=${1}
opslai=/usr/local/report/LogAnalysisInfo
oldconfig=/usr/local/report/old_config

today=`date +"%Y%m%d"`

if [ ! -d $opslai ] || [ ! -d $newlai ] ; then
    echo
    echo "Directory does not exist."
    usage
fi

echo "Updating $newlai from the contents of ${opslai} \n"

echo "cp ${opslai}/users.cfg ${newlai}/users.cfg"
cp ${opslai}/users.cfg ${newlai}/users.cfg

echo "cp ${opslai}/licenses.cfg ${newlai}/licenses.cfg"
cp ${opslai}/licenses.cfg ${newlai}/licenses.cfg

echo "cp ${opslai}/schedule.cfg ${newlai}/schedule.cfg"
cp ${opslai}/schedule.cfg ${newlai}/schedule.cfg

echo "cp ${opslai}/system.cfg ${newlai}/system.cfg"
cp ${opslai}/system.cfg ${newlai}/system.cfg

echo "cp ${opslai}/preferences.cfg ${newlai}/preferences.cfg"
cp ${opslai}/preferences.cfg ${newlai}/preferences.cfg

echo "cp ${opslai}/roles_enterprise.cfg ${newlai}/roles_enterprise.cfg"
cp ${opslai}/roles_enterprise.cfg ${newlai}/roles_enterprise.cfg

echo "cp ${opslai}/roles_standard.cfg ${newlai}/roles_standard.cfg"
cp ${opslai}/roles_standard.cfg ${newlai}/roles_standard.cfg

echo "cp -r ${opslai}/profiles/* ${newlai}/profiles"
cp ${opslai}/profiles/* ${newlai}/profiles

echo "cp ${opslai}/rewrite_rules/* ${newlai}/rewrite_rules"
cp ${opslai}/rewrite_rules/* ${newlai}/rewrite_rules

echo "cp -r ${opslai}/users_cache ${newlai}/users_cache"
cp -r ${opslai}/users_cache ${newlai}/users_cache

echo "cp -r ${opslai}/Databases ${newlai}/Databases"
cp -r ${opslai}/Databases ${newlai}/Databases

if [ -d ${opslai}/.svn ]; then
    echo "\n\nCopying PDS Engineering-specific configurations."
    echo "cp -r ${opslai}/.svn ${newlai}"
    cp -r ${opslai}/.svn ${newlai}
fi

echo "cp -r ${opslai}/login_plugins ${newlai}"
cp -r ${opslai}/login_plugins ${newlai}

echo "cp -r ${opslai}/spiders.cfg ${newlai}"
cp -r ${opslai}/spider.cfg ${newlai}

echo "\n\nRemove old databases"
echo "rm -fr ${opslai}/Databases"
rm -fr ${opslai}/Databases

echo "\n\nBackup old LogAnalysisInfo"
echo "mv ${opslai} ${oldconfig}/LogAnalysisInfo_pre${today}"
mv ${opslai} ${oldconfig}/LogAnalysisInfo_pre${today}

echo "\n\nMove new LogAnalysisInfo to ops location"
echo "mv ${newlai} ${opslai}"
mv ${newlai} ${opslai}

exit 0
