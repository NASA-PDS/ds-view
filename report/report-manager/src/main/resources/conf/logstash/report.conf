input {
  file {
    path => "/report_service/logs/final/img/img-pdsimage-http/*access_*.log"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsimage-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsimage-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-pdsimage-ftp/xferlog*"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsimage-ftp.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsimage-ftp"
      "log_format" => "ftp"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-ida-http/*access_*.log"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-ida-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-ida-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-ida-ftp/xferlog*"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-ida-ftp.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-ida-ftp"
      "log_format" => "ftp"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-pdsmaps-http/*access_*.log"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsmaps-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsmaps-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-planetary-http/*access_*.log"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-planetary-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-planetary-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-pdsimg1-http/access_log.*-*-*.txt"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsimg1-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsimg1-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-pdsimg2-http/access_log.*-*-*.txt"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsimg2-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsimg2-http"
      "log_format" => "apache_combined"
    }
  }
  file {
    path => "/report_service/logs/final/img/img-pdsimg3-http/access_log.*-*-*.txt"
    start_position => "beginning"
    ignore_older => 0
    sincedb_path => "/report_service/logstash/sincedb/img/img-pdsimg3-http.sincedb"
    add_field => {
      "node" => "img"
      "log_source" => "img-pdsimg3-http"
      "log_format" => "apache_combined"
    }
  }
}
filter {
  mutate {
    add_field => { "index_time" => "%{@timestamp}" }
  }
  if [log_format] == "apache_combined" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    useragent {
      source => "agent"
    }
  } else if [log_format] == "ftp" {
    # Parse logged request
    grok {
      patterns_dir => ["./patterns"]
      match => { "message" => "%{HTTPD_ADAPTEDLOG}" }
    }
    # Search for spiders
    grok {
      patterns_dir => ["./patterns"]
      match => { "ident" => "%{BOT_USERS}" }
      add_field => { "device" => "Spider" }
      tag_on_failure => []
    }
  }
  geoip { source => "clientip" }
  date { 
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
}
output {
  if [tags] {
    stdout { codec => "rubydebug" }
  } else {
    stdout { codec => "dots" }
    elasticsearch {
      hosts => [ "localhost:9200" ]
      index => "report"
    }
  }
}
