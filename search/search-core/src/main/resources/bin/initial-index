#! /bin/bash

CLASSPATH=/apps/search-core/bin

if [ "$1" != "" ]; then
    SOLR_HOME=${1}
    echo
    echo "SOLR_HOME = ${1}"
    echo
elif [ "$SOLR_HOME" != "" ]; then
    echo
    echo "SOLR_HOME = ${SOLR_HOME}"
    echo
elif [ "$SEARCH_SERVICE_HOME" != "" ]; then
    SOLR_HOME=$SEARCH_SERVICE_HOME
    echo
    echo "SOLR_HOME = ${SOLR_HOME}"
    echo
else
    echo
    echo "SOLR_HOME OR SEARCH_SERVICE_HOME must be specified as environment var or command-line"
    echo "    ./initial-index <search-service-home>"
    echo
    exit 0
fi

echo "-----------------------------------------------------"
echo "----------------------WARNINGS------------------------"
echo "-----------------------------------------------------"
echo " RUN ON PDSBETA ONLY! "
echo " - If on ops machine, kill script immediately."
echo
echo " SOLR_HOME must be set prior to running script"
echo " - Your SOLR_HOME = $SOLR_HOME "
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"

# Need PDS_SOLR_HOME to specify we are using the pds solr instance
PDS_SOLR_HOME=$SOLR_HOME/pds

echo $PDS_SOLR_HOME

if [ -d $PDS_SOLR_HOME/tse_old ]
then
  echo "LOG: Removing '$PDS_SOLR_HOME/tse_old/'"
  rm -rf $PDS_SOLR_HOME/tse_old
fi
if [ -d $PDS_SOLR_HOME/tse ]
then
  echo "LOG: Backing up '$PDS_SOLR_HOME/tse/' to '$PDS_SOLR_HOME/tse_old/'"
  mv $PDS_SOLR_HOME/tse $PDS_SOLR_HOME/tse_old
fi
echo


if [ -f $PDS_SOLR_HOME/index/solr_index_old.xml ]
then
  echo "LOG: Removing '$PDS_SOLR_HOME/index/solr_index_old.xml'"
  rm $PDS_SOLR_HOME/index/solr_index_old.xml
fi
if [ -f $PDS_SOLR_HOME/index/solr_index.xml ]
then
  echo "LOG: Backing up '$PDS_SOLR_HOME/index/solr_index.xml' to '$PDS_SOLR_HOME/index/solr_index_old.xml'"
  mv $PDS_SOLR_HOME/index/solr_index.xml $PDS_SOLR_HOME/index/solr_index_old.xml
fi
echo

echo
if [ -d $PDS_SOLR_HOME/catalog_index_old ]
then
  echo "LOG:Removing '$PDS_SOLR_HOME/catalog_index_old'"
  rm -rf $PDS_SOLR_HOME/catalog_index_old
fi
if [ -d $PDS_SOLR_HOME/catalog_index ]
then
  echo "Backing up '$PDS_SOLR_HOME/catalog_index' to '$PDS_SOLR_HOME/catalog_index_old'"
  mv $PDS_SOLR_HOME/catalog_index $PDS_SOLR_HOME/catalog_index_old
fi
echo
echo "---------------------------------------"
echo

echo "-----Running search-core------"
search-core $PDS_SOLR_HOME
echo "-----search-core Complete-----"

./solr-post $SOLR_HOME
