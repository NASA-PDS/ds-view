#!/bin/bash

echo
echo "Running SOLR update..."
echo

if [ "$1" != "" ]; then
    SOLR_HOME=${1}
    echo
    echo "SOLR_HOME = ${1}"
    echo
elif [ "$SOLR_HOME" != "" ]; then
    echo
    echo "SOLR_HOME = ${SOLR_HOME}"
    echo
elif [ "$SEARCH_SERVICE_HOME" != "" ]; then
    SOLR_HOME=$SEARCH_SERVICE_HOME
    echo
    echo "SOLR_HOME = ${SOLR_HOME}"
    echo
else
    echo
    echo "SOLR_HOME or SEARCH_SERVICE_HOME must be specified as environment var or via command-line:"
    echo "    ./solr-post <search-service-home>"
    echo
    exit 0
fi

PDS_SOLR_HOME=$SOLR_HOME/pds

SOLR_UPDATE="http://pdsbeta:8080/search-service/pds/update"

echo $PDS_SOLR_HOME

./xslt $SOLR_HOME $PDS_SOLR_HOME/index/solr_index.xml $PDS_SOLR_HOME/index/add-hierarchy.xslt $PDS_SOLR_HOME/index/solr-index.hierarchy.xml
./xslt $SOLR_HOME $PDS_SOLR_HOME/index/search-tools.xml $PDS_SOLR_HOME/index/add-hierarchy.xslt $PDS_SOLR_HOME/index/search-tools.hierarchy.xml

#Backup existing solr index. This currently is in the wrong place and will need updating
if [ -d $PDS_SOLR_HOME/data_old ]
then
  echo "Removing '$PDS_SOLR_HOME/data_old'"
  rm -rf $PDS_SOLR_HOME/data_old
fi
if [ -d $PDS_SOLR_HOME/data ]
then
  echo "Backing up '$PDS_SOLR_HOME/data' to '$PDS_SOLR_HOME/data_old"
  cp -rp $PDS_SOLR_HOME/data $PDS_SOLR_HOME/data_old
fi

# Delete all existing documents.
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --data-binary '<delete><query>*:*</query></delete>'

# Push new index data
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary @$PDS_SOLR_HOME/index/solr-index.hierarchy.xml
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary @$PDS_SOLR_HOME/index/search-tools.hierarchy.xml


# Commit the changes
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary '<commit />'