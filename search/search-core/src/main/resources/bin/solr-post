#!/bin/bash

####################################################################
#
# solr-post
#
# Script to post data to the search-service using cUrl.
#
# $Id$
#
####################################################################

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source ${DIR}/env-vars

if [ $# -eq 2 ]; then
    SEARCH_HOME=${1}	
    SEARCH_SERVICE_URL=${2}
elif [ "${SEARCH_HOME}" == "" ] || [ "${SEARCH_SERVICE_URL}" == "" ]; then
    echo
    echo "Usage: `basename $0` <search-home> <search-service-url>"
    echo "    or specify variables in ${DIR}/env-vars"
    echo
    exit
fi

echo
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"
echo "Posting index to SOLR"
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"
echo

OPTIMIZE_URL="${SEARCH_SERVICE_URL}/update/?optimize=true"
UPDATE_URL="${SEARCH_SERVICE_URL}/update/?commit=true"
UPDATE_XSLT_URL="${SEARCH_SERVICE_URL}/update/xslt?commit=true&tr=add-hierarchy.xsl"

# Delete all existing documents.
echo "Clear out Solr index"
curl "${UPDATE_URL}" -H "Content-Type: application/xml" --silent --data-binary '<delete><query>*:*</query></delete>'
echo
echo
# Post search tools metadata to Solr XSLT update endpoint
echo "Posting search tools to index - ${DIR}/../facets/search-tools.xml"
curl "${UPDATE_XSLT_URL}" -H "Content-Type: application/xml" --silent --request POST --data-binary @${DIR}/../facets/search-tools.xml

echo
echo

echo "Posting search core generated data"
find ${SEARCH_HOME}/index/solr_index.xml.*
for solrIndex in `find ${SEARCH_HOME}/index/solr_index.xml.*`; do
   curl "${UPDATE_XSLT_URL}" -H "Content-Type: application/xml" --silent --request POST --data-binary @$solrIndex
done

echo
echo "Optimizing index"
curl $OPTIMIZE_URL

exit 0