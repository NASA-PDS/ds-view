#! /bin/bash

CLASSPATH=/apps/search-core/bin

if [ "$SOLR_HOME" != "" ]; then
    echo
    echo "SOLR_HOME = ${SOLR_HOME}"
    echo
elif [ "$1" != "" ]; then
    SOLR_HOME=${1}
    echo
    echo "SOLR_HOME = ${1}"
    echo
else
    echo
    echo "SOLR_HOME must be specified as environment var or command-line:  ./initial-index <solr-home>"
    echo
    exit 0
fi

PDS_SOLR_HOME=$SOLR_HOME/pds

echo "-----------------------------------------------------"
echo "----------------------WARNINGS------------------------"
echo "-----------------------------------------------------"
echo " RUN ON PDSBETA ONLY! "
echo " - If on ops machine, kill script immediately."
echo
echo " SOLR_HOME must be set prior to running script"
echo " - Your SOLR_HOME = $SOLR_HOME "
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"
echo "-----------------------------------------------------"

cd $PDS_SOLR_HOME
pwd

#rm -fr catalog_index

echo "LOG: Performing an svn update on PDS_SOLR_HOME directory"
#svn update

if [ -d tse_old ]
then
  echo "LOG: Removing 'tse_old/'"
  rm -rf tse_old
fi
if [ -d tse ]
then
  echo "LOG: Backing up 'tse/' to 'tse_old/'"
  mv tse tse_old
fi
echo


if [ -f pds/solr_index_old.xml ]
then
  echo "LOG: Removing 'pds/solr_index_old.xml'"
  rm pds/solr_index_old.xml
fi
if [ -f pds/solr_index.xml ]
then
  echo "LOG: Backing up 'pds/solr_index.xml' to 'pds/solr_index_old.xml'"
  mv pds/solr_index.xml pds/solr_index_old.xml
fi
echo

echo
if [ -d catalog_index_old ]
then
  echo "LOG:Removing 'catalog_index_old'"
  rm -rf catalog_index_old
fi
if [ -d catalog_index ]
then
  echo "Backing up 'catalog_index' to 'catalog_index_old'"
  cp -r catalog_index catalog_index_old
  echo "Removing 'catalog_index' before new index is created"
  rm -fr catalog_index
  sleep 15
fi
echo
echo "---------------------------------------"
echo

echo "-----Running PDSIndexer------"
PDSIndexer $PDS_SOLR_HOME
echo "-----PDSIndexer Complete-----"

./bin/solr-post $SOLR_HOME
