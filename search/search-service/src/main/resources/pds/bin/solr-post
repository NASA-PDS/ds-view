#!/bin/bash

# May need to set SOLR_HOME in script

PDS_SOLR_HOME=$SOLR_HOME/pds

SOLR_UPDATE="http://pdsbeta/tools/search-service/pds/update/"

cd $PDS_SOLR_HOME
pwd

./bin/xslt index/solr_index.xml index/add-hierarchy.xslt index/solr-index.hierarchy.xml
./bin/xslt index/search-tools.xml index/add-hierarchy.xslt index/search-tools.hierarchy.xml

#Backup existing solr index. This currently is in the wrong place and will need updating
if [ -d data_old ]
then
  echo "Removing 'data_old'"
  rm -rf data_old
fi
if [ -d data ]
then
  echo "Backing up 'data' to 'data_old"
  cp -rp data data_old
fi

# Delete all existing documents.
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --data-binary '<delete><query>*:*</query></delete>'

# Push new index data
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary @index/solr-index.hierarchy.xml
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary @index/search-tools.hierarchy.xml


# Commit the changes
curl "$SOLR_UPDATE" -H "Content-Type: application/xml" --silent --request POST --data-binary '<commit />'