<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2012, by the California Institute of Technology.
  ALL RIGHTS RESERVED. United States Government Sponsorship acknowledged.
  Any commercial use must be negotiated with the Office of Technology Transfer
  at the California Institute of Technology.

  This software is subject to U. S. export control laws and regulations
  (22 C.F.R. 120-130 and 15 C.F.R. 730-774). To the extent that the software
  is subject to U.S. export control laws and regulations, the recipient has
  the responsibility to obtain export licenses or other export authority as
  may be required before exporting such information to foreign countries or
  providing access to foreign nationals.

  $Id$
-->

<document>
  <properties>
    <title>Operation</title>
    <author email="Michael.Cayanan@jpl.nasa.gov">Paul Ramirez</author>
    <author email="Sean.Hardman@jpl.nasa.gov">Sean Hardman</author>
  </properties>

  <body>
    <section name="Operation">
      <p>This document describes how to operate the Transform Tool. The following topics can be found in this document:
      </p>

      <ul>
        <li><a href="#Tool_Execution">Tool Execution</a></li>
        <li><a href="#PDS3_to_PDS4_Label_Transformation">PDS3 to PDS4 Label Transformation</a></li>
        <li><a href="#Advanced_Use_Cases">Advanced Use Cases</a></li>
        <li><a href="#Known_Issues">Known Issues</a></li>
      </ul>

      <p>Note: The command-line examples in this section have been broken into multiple lines for readability. The commands should be reassembled into a single line prior to execution.
      </p>
    </section>

    <section name="Tool Execution">
      <p>The Transform Tool can be executed in various ways. This section describes how to run the tool, as well as its behaviors and caveats.
      </p>

      <subsection name="Command-Line Options">
        <p>The following table describes the command-line options available:
        </p>

        <table>
          <tr><th>Command-Line Option</th><th>Description</th></tr>
          <tr><td>-t, --target</td><td>Explicitly specify a PDS3 or PDS4 product label that contains a reference to an image file to transform. The target can be specified implicitly as well. (example: transform i943630r.xml)</td></tr>
          <tr><td>-o, --output</td><td>Specify an output directory where the transformed images will reside. If this option is not specified on the command-line, the tool will default to placing the output files in the current working directory.</td></tr>
          <tr><td>-f, --format-type</td><td>Specify the transformation format type to perform on the target(s). Please see the <a href="#Format_Types">Format Types</a> section for details on the valid format types available to the tool.</td></tr>
          <tr><td>-n, --index</td><td>Specify the index of the image or table to transform. The default is to transform the first one found. Please see the <a href="#Advanced_Use_Cases">Advanced Use Cases</a> section for details on using this flag option.</td></tr>
          <tr><td>-d, --datafile &lt;file&gt;</td><td>Specify the data file to transform. The default is to transform the first one found. Please see the <a href="#Advanced_Use_Cases">Advanced Use Cases</a> section for details on using this flag option.</td></tr>
          <tr><td>-a, --all</td><td>Specify to transform all images or tables found within a given target PDS label. Please see the <a href="#Advanced_Use_Cases">Advanced Use Cases</a> section for details on using this flag option.</td></tr>
          <tr><td>-O, --list-objects</td><td>List the table and image objects found within a given label that are currently supported by the tool.</td></tr>
          <tr><td>-V, --version</td><td>Display the release number and copyright information.</td></tr>
          <tr><td>-h, --help</td><td>Display tool usage.</td></tr>
        </table>
      </subsection>

      <subsection name="Format Types">
        <p>The following table lists the output formats available to both PDS3 and PDS4 target inputs:
        </p>

        <table>
          <tr><th>Format Type</th><th>Description</th></tr>
          <tr><td>jpeg or jpg</td><td>Specify to transform to an image in a Joint Photogrpahic Experts Group format.</td></tr>
          <tr><td>jp2</td><td>Transform an image to a JPEG 2000 format.</td></tr>
          <tr><td>bmp</td><td>Transform an image to a Windows bitmap format.</td></tr>
          <tr><td>wbmp</td><td>Transform an image to a Wireless Bitmap image format.</td></tr>
          <tr><td>gif</td><td>Transform an image to a Graphics Interchange Format.</td></tr>
          <tr><td>png</td><td>Transform an image to a Portable Network Graphics format.</td></tr>
          <tr><td>raw</td><td>Transform an image to a Raw image format.</td></tr>
          <tr><td>tif or tiff</td><td>Transform an image to a Tagged Image File Format.</td></tr>
          <tr><td>pnm</td><td>Transform an image to a Portable Any Map format.</td></tr>
        </table>

        <p>The following table lists the output formats available to only PDS4 target inputs:
        </p>

        <table>
          <tr><th>Format Type</th><th>Description</th></tr>
          <tr><td>pvl</td><td>Transform a given PDS4 label into a Parameter Value Language file.</td></tr>
          <tr><td>html</td><td>Transform a given PDS4 label into an html representation of the label.</td></tr>
          <tr><td>html-structure-only</td><td>Transform a given PDS4 label into an html representation of the label structure. As a result, the element contents are stripped out in the resulting file.</td></tr>
          <tr><td>csv</td><td>Transform a given table into a comma-separated value file.</td></tr>
        </table>

        <p>>The following table lists the output formats available to only PDS3 target inputs:
        </p>

        <table>
          <tr><th>Format Type</th><th>Description</th></tr>
          <tr><td>pds</td><td>Transform a VICAR image into a PDS4 Array 2D image. Additionally, the given PDS3 label will be transformed into a PDS4 label. Note that this transformation currently applies to target VICAR images only. Please see the <a href="#PDS3_to_PDS4_Label_Transformation">PDS3 to PDS4 Label Transformation</a> section for more details on how the tool performs a PDS3 to PDS4 label transformation.</td></tr>
          <tr><td>pds4-label</td><td>Transform a given PDS3 data product label into a PDS4 Product Observational product label. Please see the <a href="#PDS3_to_PDS4_Label_Transformation">PDS3 to PDS4 Label Transformation</a> section for more details on how the tool performs a PDS3 to PDS4 label transformation. </td></tr>
        </table>
      </subsection>

      <subsection name="Running the Transform Tool">
        <p>The Transform Tool requires the passing in of a PDS3 or PDS4 product label that contains a reference to an image file. In addition, the tool assumes that the referenced image file is co-located with the product label. Under the current implementation, if there are multiple image files referenced in a target label, the tool will default to only transforming the first image file reference. Other notable caveats with this initial version of the tool include:
        </p>

        <ul>
          <li>Transformations of PDS3 images greater than 8-bits are not supported at the moment.</li>
          <li>For PDS3 to TIFF transformations, the output tile size defaults to 8 lines by the image width.</li>
        </ul>

        <p>This section demonstrates some of the ways that the tool can be executed using the command-line option flags:
        </p>

        <ul>
          <li>Transform a Single PDS4 Array 2D Image</li>
          <li>Transform a Single PDS4 Label To Parameter Value Language (PVL) File</li>
          <li>Transform a Single 8-Bit PDS3 Image</li>
          <li>Transform a PDS3 Label to PDS4 Label</li>
          <li>List the Supported Objects</li>
        </ul>

        <p>The files used in the command-line examples below are packaged with the tool in the <i>examples</i> directory.
        </p>

        <p><b><i>Transform a Single PDS4 Array 2D Image</i></b></p>

        <p>The following command demonstrates transforming a PDS4 array 2D image referenced in the associated product label, <i>i943630r.xml</i>, into a jpeg image file named <i>i943630r.jpg</i>:
        </p>

        <source>
% transform ../examples/i943630r.xml -f jpg
        </source>

        <p>Under the current implementation, for PDS4 data products, the tool only supports the transformation of array 2D images.
        </p>

        <p>If the <i>-o</i> flag option is not specified on the command-line, the tool will default to creating an output file using the target image file name with the user-specified format as the file extension. The resulting output file will be written to the current working directory. The following command demonstrates transforming a PDS4 array 2D image referenced in the associated product label, <i>i943630r.xml</i>, into a graphics interchange format file:
        </p>

        <source>
% transform ../examples/i943630r.xml -f gif
        </source>

        <p>The resulting output is written to the output file <i>i943630r.gif</i> in the current working directory.
        </p>

        <p><b><i>Transform a Single PDS4 Label To Parameter Value Language (PVL) File</i></b></p>

        <p>The following command demonstrates transforming a PDS4 label, <i>i943630r.xml</i>, to a PVL file, <i>i943630r.pvl</i>:
        </p>

        <source>
% transform ../examples/i943630r.xml -f pvl
        </source>

        <p><b><i>Transform a Single 8-Bit PDS3 Image</i></b></p>

        <p>The following command demonstrates transforming a PDS3, 8-bit image referenced in the associated attached label, <i>FHA01118.LBL</i>, into a bitmap image file named <i>FHA01118.BMP</i>:
        </p>

        <source>
% transform ../examples/FHA01118.LBL -f bmp
        </source>

        <p>The following command demonstrates transforming a PDS3, 8-bit image referenced in the associated detached label, <i>FF01.LBL</i>, into a portable network graphics file named <i>FF01.PNG</i>:
        </p>

        <source>
% transform ../examples/FF01.LBL -f png
        </source>

        <p><b><i>Transform a PDS3 Label to PDS4 Label</i></b></p>

        <p>The following command demonstrates transforming a PDS3 data product label, <i>ELE_MOM.LBL</i>, into a PDS4 Product Observational label named <i>ele_mom.xml</i>:
        </p>
        <source>
% transform ../examples/ELE_MOM.LBL -f pds4-label
        </source>
      </subsection>

      <subsection name="Advanced Use Cases">
        <p>A common use case scenario of the Transform Tool is to transform a label that points to a single data file containing a single image or table. A more advanced use case scenario is handling a label that points to multiple data files where each data file contains multiple images or tables. This section details how to tell the Transform Tool to transform a specific image or table if given a more complex label.
        </p>

        <p>Note: The flag options that allow control of which images to transform, <i>-n, -d, -a</i>, are not supported with PDS3 labels pointing to multiple, non-FITS, image transformations.
        </p>

        <p><b><i>Transform a Specific Table</i></b></p>

        <p>Use the <i>-O,--list-objects</i> flag option to first list the table objects being supported by the tool:
        </p>

        <source>
% transform ../examples/Product_Table_Multiple_Tables.xml -O
        </source>

        <p>This will display the supported table objects:
        </p>

        <source>
Supported Images:

  None Found

Supported Tables:

  Data file: PDS4_ATM_TABLE_CHAR_MULTIPLE.TAB

    index = 1
    local identifier = TABLE_CHAR_1
    type = fixed-width character table
    records = 23
    record length = 88
    groups = 0
    fields = 10

    index = 2
    local identifier = TABLE_CHAR_2
    type = fixed-width character table
    records = 23
    record length = 88
    groups = 0
    fields = 10
        </source>

        <p>To perform a table to CSV transformation of the 2nd table, run the following command:
        </p>

        <source>
% transform ../examples/Product_Table_Multiple_Tables.xml -f csv -n 2
        </source>

        <p><b><i>Transform a Specific Data File</i></b></p>

        <p>Use the <i>-O,--list-objects</i> flag option to first list the table objects being supported by the tool:
        </p>

        <source>
% ./transform ../examples/Product_Table_Multiple_Datafiles.xml -O
        </source>

        <p>This will display the supported table objects:
        </p>

        <source>
Supported Images:

  None Found

Supported Tables:

  Data file: PDS4_ATM_TABLE_CHAR.TAB

    index = 1
    local identifier = PHX-M-TT-5-WIND-VEL-DIR_TABLE_CHAR
    type = fixed-width character table
    records = 23
    record length = 88
    groups = 0
    fields = 10

  Data file: PDS4_TABLE_DELIMITED.csv

    index = 1
    local identifier = null
    type = delimited table
    records = 3
    groups = 0
    fields = 13

  Data file: 2d234493326edratf3d2537n0m1.dat

    index = 1
    local identifier = null
    type = fixed-width binary table
    records = 336
    record length = 96
    groups = 1
    fields = 20
        </source>

        <p>The following command demonstrates transforming the table associated with the data file <i>PDS4_TABLE_DELIMTED.csv</i>:
        </p>

        <source>
% transform ../examples/Product_Table_Multiple_Datafiles.xml -f csv -d PDS4_TABLE_DELIMITED.csv
        </source>

        <p><b><i>Transform Everything</i></b></p>

        <p>Display the list of FITS images supported by the tool using the <i>-O, --list-objects</i> flag option:
        </p>

        <source>
% ./transform ../examples/20140804T205944Z_MAP_bias_V001.xml -O
        </source>

        <p>This will display the following:
        </p>

        <source>
Supported Images:

  Data file: 20140804T205944Z_MAP_bias_V001.fits

    index = 1
    local identifier = PDU
    data type = IEEE754LSBSingle
    lines = 1024
    samples = 1024

    index = 2
    local identifier = SDU
    data type = IEEE754LSBSingle
    lines = 1044
    samples = 1112

Supported Tables:

  None Found
        </source>

        <p>The following command demonstrates transforming all FITS images found in the label:
        </p>

        <source>
% transform ../examples/20140804T205944Z_MAP_bias_V001.xml -f jpg -a
        </source>

        <p>The label points to a single data file that contains multiple images. So the tool ends up creating the following output files:
        </p>

        <ul>
          <li>20140804T205944Z_MAP_bias_V001_1.jpg</li>
          <li>20140804T205944Z_MAP_bias_V001_2.jpg</li>
        </ul>

        <p>Note that the tool appends an index value to the end of each output file name whenever the tool has to transform multiple images or tables contained within a single data file.
        </p>

      </subsection>
    </section>

    <section name="PDS3 to PDS4 Label Transformation">
      <p>The intent of the PDS3 to PDS4 label transformation is to transform a PDS3 data product label into a PDS4 Product Observational product label with the minimum set of elements in order to be compliant with the PDS4 standards. Therefore, not all PDS3 keywords will map to the resulting label. This section details how the Transform tool populates some of the required elements of a PDS4 label. Please see the <a href="#Known_Issues">Known Issues</a> section for details on the limitations with PDS3 to PDS4 label transformations.
      </p>

      <subsection name="Populating PDS4 Elements">
        <p>This section describes how the tool leverages the PDS3 label in order to populate some of the PDS4 elements. Below is a list of PDS4 elements and a description of how the tool goes about populating that element.
        </p>

        <p><b><i>logical_identifier</i></b></p>

        <p>The tool will populate the <i>logical_identifier</i> element in the following mannner:
        </p>

        <source>
urn:nasa:pds:data:${DATA_SET_ID}:${PRODUCT_ID}
        </source>

        <p>If <i>PRODUCT_ID</i> does not exist in the PDS3 label, then the tool will default to using the label filename instead:
        </p>

        <source>
urn:nasa:pds:data:${DATA_SET_ID}:${labelFilename}
        </source>

        <p><b><i>title</i></b></p>

        <p>The tool will populate the <i>title</i> element in the PDS4 label based on the existency of one or more of the following keywords:
        </p>

        <ul>
          <li>OBSERVATION_NAME or</li>
          <li>OBSERVATION_ID or</li>
          <li>PRODUCT_NAME or</li>
          <li>DATA_SET_ID + PRODUCT_ID or</li>
          <li>DATA_SET_ID</li>
        </ul>

        <p>So if <i>OBSERVATION_NAME</i> exists in the PDS3 label, it will use that to populate the <i>title</i> element. If it does not exist, it will use <i>OBSERVATION_ID</i>. If that does not exist, then it will use <i>PRODUCT_NAME</i>, and so forth.
        </p>

        <p><b><i>Investigation_Area</i></b></p>

        <p>For the <i>Investigation_Area</i>, the tool will use <i>MISSION_NAME</i> to populate this element in the following manner:
        </p>

        <source>
&lt;name&gt;${MISSION_NAME}&lt;/name&gt;
&lt;type&gt;Mission&lt;/type&gt;
&lt;Internal_Reference&gt;
  &lt;lid_reference&gt;urn:nasa:pds:investigation.${MISSION_NAME}&lt;/lid_reference&gt;
  &lt;reference_type&gt;data_to_investigation&lt;/reference_type&gt;
&lt;/Internal_Reference&gt;
        </source>

        <p>If <i>MISSION_NAME</i> does not exist, then the tool will use <i>MISSION_PHASE_NAME</i> instead.
        </p>

        <p><b><i>Observing_System</i></b></p>

        <p>For the <i>Observing_System</i>, the tool will populate this element with <i>INSTRUMENT_HOST_NAME</i>, <i>INSTRUMENT_NAME</i>, and <i>INSTRUMENT_ID</i> in the following manner:
        </p>

        <source>
&lt;Observing_System_Component&gt;
  &lt;name&gt;${INSTRUMENT_HOST_NAME}&lt;/name&gt;
  &lt;type&gt;Spacecraft&lt;/type&gt;
&lt;/Observing_System_Component&gt;

&lt;Observing_System_Component&gt;
  &lt;name&gt;${INSTRUMENT_NAME}&lt;/name&gt;
  &lt;type&gt;Instrument&lt;/type&gt;
&lt;/Observing_System_Component&gt;

&lt;Observing_System_Component&gt;
  &lt;name&gt;${INSTRUMENT_ID}&lt;/name&gt;
  &lt;type&gt;Instrument&lt;/type&gt;
&lt;/Observing_System_Component&gt;
        </source>

      </subsection>
    </section>

    <section name="Known Issues">
      <p>This section describes some of the known issues and limitations with the Transform Tool.
      </p>

      <p><b><i>PDS3 Image Transformations</i></b></p>

      <ul>
        <li>The flag options that allow control of which images to transform, <i>-n, -d, -a</i>, are only supported with FITS image transformations. If the tool is given a PDS3 product label pointing to multiple, non-FITS images, the current implementation is limited to the transformation of the first image only.</li>
        <li>For detached labels, the following exception will appear on the standard out even though the tool transforms the given image successfully:
<source>
IOException attempting to read embedded vicar label jpl.mipl.io.vicar.VicarLabelSyntaxException: \
Main and EOL labels must start with LBLSIZE keyword
jpl.mipl.io.vicar.VicarLabelSyntaxException: Main and EOL labels must start with LBLSIZE keyword
    at jpl.mipl.io.vicar.VicarLabel.readLabelChunk(VicarLabel.java:122)
    at jpl.mipl.io.vicar.VicarLabel.readLabelChunk(VicarLabel.java:173)
...
</source>
        This can be safely ignored.
        </li>
      </ul>

      <p><b><i>PDS4 Image Transformations</i></b></p>

      <p>The tool may not support image transformations other than those with a data type of "UnsignedMSB2". It has been tested with a PDS4 image of type "SignedMSB2", which throws the following error even though this is a valid data type according to the PDS data model:
      </p>

      <source>
Array data type is not valid, null, or unsupported
      </source>

      <p>Due to lack of PDS4 image test data, it is unknown at this time what other data types are supported by the tool.
      </p>

      <p><b><i>PDS3 to PDS4 Label Transformations</i></b></p>

      <p>At this time, the Transform tool will support PDS3 to PDS4 label transformations of the following object types:
      </p>

      <ul>
        <li>TABLE</li>
        <li>SERIES</li>
        <li>COLUMN</li>
        <li>BIT_COLUMN</li>
        <li>CONTAINER</li>
        <li>IMAGE</li>
        <li>SPREADSHEET</li>
      </ul>

      <p>Explicit FILE objects, QUBE objects, as well as labels containing pointers to label fragments (i.e. ^STRUCTURE) are not supported by the tool at this time.
      </p>

    </section>
  </body>
</document>
